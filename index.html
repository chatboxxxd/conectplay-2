<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ConectPlay — Afiliados</title>

<!-- Google font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

<!-- PapaParse (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<style>
  :root{
    --bg1: #0b0720;
    --accent1: #6f3bff;
    --accent2: #22b0ff;
    --text: #f5f5f7;
    --muted: #bfb8d6;
    --card-bg: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family: "Montserrat", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(34,176,255,0.06), transparent 10%),
      radial-gradient(900px 400px at 90% 90%, rgba(111,59,255,0.06), transparent 10%),
      var(--bg1);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:24px;
  }

  .container{
    max-width:980px;
    margin:18px auto;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;
    padding:28px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.03);
  }

  h1, h2, h3 {
    margin-top: 0;
  }

  #rankingTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
    color: var(--text);
  }
  #rankingTable th, #rankingTable td {
    border: 1px solid rgba(255,255,255,0.1);
    padding: 10px;
    text-align: center;
  }
  #rankingTable th {
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: white;
  }
  #rankingTable td.apelido {
    text-align: left;
  }

  .affiliate-section {
    margin-top: 20px;
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
  }
  input#affiliateInput {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: transparent;
    color: var(--text);
    font-weight: 600;
  }
  button#copyBtn {
    margin-top: 8px;
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: white;
    font-weight: 700;
    cursor: pointer;
  }

  .small {
    font-size: 13px;
    color: var(--muted);
    margin-top: 6px;
  }
</style>
</head>
<body>

<div class="container" role="main">
  <h1>ConectPlay — Programa de Afiliados</h1>

  <div class="affiliate-section" aria-label="Link de afiliado">
    <label for="affiliateInput" style="font-weight:700;">Seu link de afiliado:</label>
    <input type="text" id="affiliateInput" readonly aria-describedby="copyHelp" />
    <button id="copyBtn">Copiar link de afiliado</button>
    <div id="copyHelp" class="small">Copie e envie esse link para suas indicações.</div>
  </div>

  <section aria-label="Ranking de vendas" style="margin-top:30px;">
    <h2>Ranking de Vendas</h2>
    <table id="rankingTable" role="table" aria-live="polite" aria-describedby="rankingDesc">
      <thead>
        <tr>
          <th>Apelido</th>
          <th>Quantidade de Vendas</th>
          <th>Última Venda (Data)</th>
          <th>Comissão (R$7 por venda)</th>
        </tr>
      </thead>
      <tbody id="rankingBody">
        <tr><td colspan="4" style="text-align:center;">Carregando dados...</td></tr>
      </tbody>
    </table>
    <div id="rankingDesc" class="small">Tabela mostrando o total de vendas e comissões dos afiliados.</div>
  </section>
</div>

<script>
  // URL pública CSV da planilha, ajusta para a sua
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRVxgmYQsCQMXj4hycv10FMS8vNm1CF3EXgbyz2yVE-_ljhsPMmv0HOppUlYnMUejkuVcErojpLchgF/pub?gid=0&single=true&output=csv';

  // Pega o parâmetro apelido da URL (para gerar o link de afiliado)
  function getParam(name){
    name = name.replace(/[[]]/g, '\\$&');
    const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    const results = regex.exec(window.location.href);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  // Formata data para dd/mm/yyyy (padrão BR)
  function formatDate(dateStr){
    if(!dateStr) return '-';
    const d = new Date(dateStr);
    if(isNaN(d)) return dateStr; // se não é data válida retorna original
    return d.toLocaleDateString('pt-BR');
  }

  // Função para copiar texto para clipboard
  async function copyToClipboard(text){
    try {
      await navigator.clipboard.writeText(text);
      alert('Link copiado para a área de transferência!');
    } catch {
      // fallback
      const input = document.createElement('input');
      document.body.appendChild(input);
      input.value = text;
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
      alert('Link copiado (fallback).');
    }
  }

  // Monta o link de afiliado atual com apelido (se houver)
  function buildAffiliateLink(apelido){
    const url = new URL(window.location.href.split('#')[0]);
    if(apelido) url.searchParams.set('apelido', apelido);
    else url.searchParams.delete('apelido');
    return url.toString();
  }

  // Carrega e processa o CSV, mostra tabela de ranking
  function loadRanking(){
    const tbody = document.getElementById('rankingBody');
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Carregando dados...</td></tr>';

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results){
        let data = results.data || [];

        // Agrupar dados por apelido
        const map = {};
        data.forEach(row => {
          // Normaliza colunas para evitar erros
          const apelido = (row['Apelido'] || row['apelido'] || '').trim();
          const quantidadeStr = (row['Quantidade'] || row['quantidade'] || '0').toString().trim();
          const dataStr = (row['Data'] || row['data'] || '').trim();

          if(!apelido) return; // ignora linhas sem apelido

          const quantidade = parseInt(quantidadeStr.replace(/\D/g, '')) || 0;

          if(!map[apelido]){
            map[apelido] = {
              apelido,
              quantidade: 0,
              ultimaData: null
            };
          }

          map[apelido].quantidade += quantidade;

          // Atualiza última data se for maior
          if(dataStr){
            const dataVenda = new Date(dataStr);
            if(!isNaN(dataVenda)){
              if(!map[apelido].ultimaData || dataVenda > map[apelido].ultimaData){
                map[apelido].ultimaData = dataVenda;
              }
            }
          }
        });

        // Converter para array e ordenar por quantidade decrescente
        const arr = Object.values(map).sort((a,b) => b.quantidade - a.quantidade);

        if(arr.length === 0){
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhuma venda registrada.</td></tr>';
          return;
        }

        // Monta as linhas da tabela
        tbody.innerHTML = '';
        arr.forEach(item => {
          const comissaoTotal = item.quantidade * 7; // R$7 por venda
          tbody.innerHTML += `
            <tr>
              <td class="apelido">${item.apelido}</td>
              <td>${item.quantidade}</td>
              <td>${formatDate(item.ultimaData)}</td>
              <td>R$ ${comissaoTotal.toFixed(2)}</td>
            </tr>
          `;
        });
      },
      error: function(err){
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Erro ao carregar dados: ${err}</td></tr>`;
      }
    });
  }

  // Inicializa a página
  document.addEventListener('DOMContentLoaded', () => {
    const apelido = getParam('apelido');
    const linkInput = document.getElementById('affiliateInput');

    // Preenche campo link de afiliado
    linkInput.value = buildAffiliateLink(apelido);

    // Botão copiar
    document.getElementById('copyBtn').addEventListener('click', () => {
      copyToClipboard(linkInput.value);
    });

    loadRanking();
  });
</script>

</body>
</html>
