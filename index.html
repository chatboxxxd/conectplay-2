<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ConectPlay — Afiliados & Planos</title>

<style>
  :root{
    --bg1:#241041;
    --bg2:#0e5bff;
    --card: rgba(255,255,255,0.10);
    --accent: #6a5acd;
    --accent-hover: #483d8b;
    --whatsapp: #25D366;
  }
  body{
    margin:0;
    font-family: "Arial",sans-serif;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#fff;
    padding:20px;
    min-height:100vh;
  }
  .container{ max-width:980px; margin:0 auto; }
  header{ text-align:center; margin-bottom:18px; }
  h1{ margin:4px 0 6px; font-weight:600; }

  .top-box{
    background: var(--card);
    padding:12px;
    border-radius:10px;
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:18px;
    flex-wrap:wrap;
  }
  .top-left{ flex:1 1 320px; min-width:220px; }
  label{ display:block; font-size:13px; opacity:0.9; margin-bottom:6px; }
  select,input[type="text"]{
    width:100%;
    padding:10px;
    border-radius:8px;
    border: none;
    background: rgba(255,255,255,0.05);
    color: #fff;
    box-sizing:border-box;
  }
  .small{ font-size:13px; opacity:0.9; margin-top:6px; }

  .top-actions{ display:flex; gap:10px; align-items:center; }
  .btn{
    background: var(--accent);
    color:white;
    padding:10px 14px;
    border-radius:8px;
    text-decoration:none;
    display:inline-block;
    font-weight:600;
    border:none;
    cursor:pointer;
  }
  .btn:hover{ background: var(--accent-hover); }
  .btn-outline{
    background:transparent;
    border:1px solid rgba(255,255,255,0.12);
  }

  .link-preview{
    background: rgba(255,255,255,0.06);
    padding:10px;
    border-radius:8px;
    word-break:break-word;
    max-width:100%;
  }

  .plans{
    margin-bottom:20px;
  }
  .plan-card{
    background: var(--card);
    padding:12px;
    border-radius:10px;
    margin-bottom:10px;
  }
  .plan-title{
    font-weight:700;
  }
  .plan-price{
    opacity:0.9;
    margin-top:4px;
  }

  .summary {
    background: var(--card);
    padding:12px;
    border-radius:10px;
    margin-top:20px;
  }

  footer{ margin-top:30px; font-size:13px; opacity:0.9; text-align:center; }
</style>
</head>
<body>

  <div class="container">

    <header>
      <h1>ConectPlay — Afiliados & Planos</h1>
      <p>Gere seu link, compartilhe e registre vendas diretamente aqui.</p>
    </header>

    <div class="top-box">

      <div class="top-left">
        <label for="affiliate-input">Digite seu apelido (sem espaços ou símbolos):</label>
        <input id="affiliate-input" type="text" placeholder="Ex: joao-silva" />
        <div class="small">Apenas letras, números e hífens são permitidos.</div>
      </div>

      <div style="flex:0 0 320px;">
        <label>Pré-visualização da mensagem (para WhatsApp):</label>
        <div class="link-preview" id="message-preview">—</div>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-outline" id="btn-generate" disabled>Gerar Link</button>
          <button class="btn" id="btn-copy" disabled>Copiar Texto</button>
          <button class="btn" id="btn-register" disabled>Registrar Venda</button>
        </div>
      </div>

    </div>

    <section class="plans" id="plans-list">
      <h2>Planos Disponíveis</h2>
      <!-- planos serão inseridos aqui -->
    </section>

    <section class="summary" id="summary">
      <h3>Resumo das Vendas do Afiliado</h3>
      <p id="summary-text">Digite seu apelido para ver suas vendas e comissão.</p>
    </section>

  </div>

  <footer>
    &copy; 2025 ConectPlay. Todos os direitos reservados.
  </footer>

<script>
  // URL do seu Google Apps Script (troque pelo seu)
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyRsL2wd3BUMdI1NyrAZYQeeUulYJpAVc4TkBEfZJBJsPGPJQgCfWfe79O__XI364Oz/exec";

  // Planos (fácil de alterar)
  const PLANS = [
    { id:'15dias', title: '15 DIAS DE USO', price: 'R$14,99' },
    { id:'mensal1', title: 'Mensal - 1 acesso', price: 'R$20,99' },
    { id:'mensal2', title: 'Mensal - 2 acessos', price: 'R$25,99' },
    { id:'bimestral1', title: 'Bimestral - 1 acesso', price: 'R$41,99' },
    { id:'bimestral2', title: 'Bimestral - 2 acessos', price: 'R$43,99' },
    { id:'trimestral1', title: 'Trimestral - 1 acesso', price: 'R$74,99' },
    { id:'trimestral2', title: 'Trimestral - 2 acessos', price: 'R$76,99' },
    { id:'semestral1', title: 'Semestral - 1 acesso', price: 'R$149,99' },
    { id:'semestral2', title: 'Semestral - 2 acessos', price: 'R$153,99' },
    { id:'anual1', title: 'Anual - 1 acesso', price: 'R$297,99' },
    { id:'anual2', title: 'Anual - 2 acessos', price: 'R$299,99' }
  ];

  // Referências DOM
  const affiliateInput = document.getElementById('affiliate-input');
  const messagePreview = document.getElementById('message-preview');
  const btnGenerate = document.getElementById('btn-generate');
  const btnCopy = document.getElementById('btn-copy');
  const btnRegister = document.getElementById('btn-register');
  const plansList = document.getElementById('plans-list');
  const summaryText = document.getElementById('summary-text');

  // Estado interno
  let selectedPlanId = null;
  let affiliateSlug = "";

  // Função para normalizar apelido para URL / slug
  function makeSlug(name) {
    return name.trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9\-]+/g,'-')
      .replace(/\-+/g,'-')
      .replace(/^\-+|\-+$/g,'');
  }

  // Mostrar planos na página
  function showPlans() {
    plansList.innerHTML = "<h2>Planos Disponíveis</h2>" + PLANS.map(plan => `
      <div class="plan-card">
        <input type="radio" name="plan" id="plan-${plan.id}" value="${plan.id}">
        <label for="plan-${plan.id}">
          <span class="plan-title">${plan.title}</span><br>
          <span class="plan-price">${plan.price}</span>
        </label>
      </div>
    `).join('');
    // Evento para marcar plano selecionado
    plansList.querySelectorAll('input[name="plan"]').forEach(input => {
      input.addEventListener('change', () => {
        selectedPlanId = input.value;
        updateMessagePreview();
        checkButtons();
      });
    });
  }

  // Atualizar preview da mensagem
  function updateMessagePreview() {
    affiliateSlug = makeSlug(affiliateInput.value);
    if(!affiliateSlug) {
      messagePreview.textContent = "Digite um apelido válido.";
      disableButtons();
      return;
    }
    if(!selectedPlanId) {
      messagePreview.textContent = "Escolha um plano para gerar o link.";
      disableButtons();
      return;
    }
    const plan = PLANS.find(p => p.id === selectedPlanId);
    if(!plan) {
      messagePreview.textContent = "Plano inválido.";
      disableButtons();
      return;
    }

    const msg = `Olá! Quero assinar IPTV com o código de afiliado: ${affiliateSlug}. Plano: ${plan.title} (${plan.price}).`;
    messagePreview.textContent = msg;
    enableButtons();
  }

  function enableButtons(){
    btnGenerate.disabled = false;
    btnCopy.disabled = false;
    btnRegister.disabled = false;
  }

  function disableButtons(){
    btnGenerate.disabled = true;
    btnCopy.disabled = true;
    btnRegister.disabled = true;
  }

  // Copiar mensagem para área de transferência
  btnCopy.addEventListener('click', () => {
    navigator.clipboard.writeText(messagePreview.textContent).then(() => {
      alert("Mensagem copiada!");
    });
  });

  // Gerar link WhatsApp e abrir nova aba
  btnGenerate.addEventListener('click', () => {
    const phone = "557791986049"; // Seu número WhatsApp com DDD e sem "+"
    const url = `https://api.whatsapp.com/send?phone=${phone}&text=` + encodeURIComponent(messagePreview.textContent);
    window.open(url, "_blank");
  });

  // Registrar venda na planilha via Google Apps Script
  btnRegister.addEventListener('click', () => {
    if(!affiliateSlug || !selectedPlanId) {
      alert("Preencha o apelido e selecione um plano.");
      return;
    }
    const plan = PLANS.find(p => p.id === selectedPlanId);

    const url = `${GAS_URL}?afiliado=${encodeURIComponent(affiliateSlug)}&cliente=Cliente&plano=${encodeURIComponent(plan.title)}`;

    fetch(url)
      .then(resp => resp.text())
      .then(data => {
        alert("Venda registrada com sucesso!");
        loadAffiliateSummary(affiliateSlug);
      })
      .catch(err => {
        console.error(err);
        alert("Erro ao registrar venda.");
      });
  });

  // Função para buscar a contagem de vendas do afiliado na planilha via CSV pública
  function loadAffiliateSummary(affiliate) {
    // URL pública da sua planilha CSV, substitua pelo seu link correto da aba com as vendas consolidadas
    const CSV_VENDAS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkBMVMdYu-Nfefrw8mqtyMtjNPJRteAnVWJw8aWBgVT6iq2EUMyjgNPGPlv5PUN7i38J_f4ui3bftm/pub?gid=144607695&single=true&output=csv";

    fetch(CSV_VENDAS_URL)
      .then(resp => resp.text())
      .then(text => {
        const lines = text.trim().split('\n');
        // Esperando colunas: Apelido Afiliado, Total Vendas (na aba resumo)
        let totalVendas = 0;
        for(let i=1; i<lines.length; i++) {
          const cols = lines[i].split(',');
          const apelido = cols[0].trim();
          const vendas = parseInt(cols[1]) || 0;
          if(apelido.toLowerCase() === affiliate.toLowerCase()) {
            totalVendas = vendas;
            break;
          }
        }

        const comissao = calcularComissao(totalVendas);

        if(totalVendas > 0){
          summaryText.innerHTML = `
            Olá, <strong>${affiliate}</strong>!<br>
            Você fez <strong>${totalVendas}</strong> venda(s).<br>
            Sua comissão por venda é <strong>R$ ${comissao.toFixed(2)}</strong>.<br>
            Você já ganhou <strong>R$ ${(totalVendas*comissao).toFixed(2)}</strong>.
          `;
        } else {
          summaryText.innerHTML = `Olá, <strong>${affiliate}</strong>! Ainda não há vendas registradas.`;
        }

      }).catch(err => {
        console.error("Erro ao carregar resumo:", err);
        summaryText.textContent = "Erro ao carregar resumo de vendas.";
      });
  }

  // Função que calcula a comissão com base no número de vendas
  function calcularComissao(vendas) {
    if(vendas >= 601) return 10.00;
    if(vendas >= 301) return 9.00;
    if(vendas >= 101) return 8.00;
    if(vendas >= 1) return 7.00;
    return 0;
  }

  // Evento para atualizar o preview e resumo quando digitar apelido
  affiliateInput.addEventListener('input', () => {
    updateMessagePreview();
    if(makeSlug(affiliateInput.value)) {
      loadAffiliateSummary(makeSlug(affiliateInput.value));
    } else {
      summaryText.textContent = "Digite seu apelido para ver suas vendas e comissão.";
    }
  });

  // Inicializa a página
  showPlans();
  disableButtons();
</script>

</body>
</html>
