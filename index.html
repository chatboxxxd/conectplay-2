<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ConectPlay — Afiliados, Planos e Ranking</title>

<style>
  :root{
    --bg1:#241041;
    --bg2:#0e5bff;
    --card: rgba(255,255,255,0.10);
    --accent: #6a5acd;
    --accent-hover: #483d8b;
    --whatsapp: #25D366;
  }
  body{
    margin:0;
    font-family: "Arial",sans-serif;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#fff;
    padding:20px;
    min-height:100vh;
  }
  .container{ max-width:980px; margin:0 auto; }
  header{ text-align:center; margin-bottom:18px; }
  header img{ max-width:180px; height:auto; display:block; margin: 0 auto 8px; }
  h1{ margin:4px 0 6px; font-weight:600; }
  p.lead{ opacity:0.9; margin-top:0; }

  .top-box{
    background: var(--card);
    padding:12px;
    border-radius:10px;
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:18px;
    flex-wrap:wrap;
  }
  .top-left{ flex:1 1 320px; min-width:220px; }
  label{ display:block; font-size:13px; opacity:0.9; margin-bottom:6px; }
  select,input[type="text"]{
    width:100%;
    padding:10px;
    border-radius:8px;
    border: none;
    background: rgba(255,255,255,0.05);
    color: #fff;
    box-sizing:border-box;
  }
  .small{ font-size:13px; opacity:0.9; margin-top:6px; }

  .top-actions{ display:flex; gap:10px; align-items:center; }
  .btn{
    background: var(--accent);
    color:white;
    padding:10px 14px;
    border-radius:8px;
    text-decoration:none;
    font-weight:600;
    border:none;
    cursor:pointer;
  }
  .btn:hover{ background: var(--accent-hover); }
  .btn-outline{
    background:transparent;
    border:1px solid rgba(255,255,255,0.12);
  }

  .link-preview{
    background: rgba(255,255,255,0.06);
    padding:10px;
    border-radius:8px;
    word-break:break-word;
    max-width:100%;
  }

  .plans{
    display:flex; flex-direction:column; gap:10px;
    margin-bottom:20px;
  }
  .plan-card{
    background: var(--card);
    padding:12px;
    border-radius:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .plan-info{ text-align:left; }
  .plan-title{ font-weight:700; margin-bottom:4px; }
  .plan-price{ opacity:0.95; font-size:14px; }

  #ranking-list {
    list-style-type: none;
    padding: 0;
    margin: 0;
  }
  #ranking-list li {
    background: var(--card);
    margin: 6px 0;
    padding: 10px;
    border-radius: 8px;
  }

  .wh-btn{
    display:inline-flex; align-items:center; gap:8px;
    background:var(--whatsapp); color:#fff; padding:8px 12px; border-radius:8px;
    text-decoration:none; font-weight:700; border:none; cursor:pointer;
  }
  .wh-btn svg{ width:18px; height:18px; }

  footer{ margin-top:18px; font-size:13px; opacity:0.9; text-align:center; }

</style>
</head>
<body>
  <div class="container">
    <header>
      <img src="images/logo-conectplay.png" alt="Logo ConectPlay" onerror="this.style.display='none'"/>
      <h1>ConectPlay — Afiliados, Planos e Ranking</h1>
      <p class="lead">Gere seu link, compartilhe e acompanhe o ranking atualizado!</p>
    </header>

    <div class="top-box" id="top-box">
      <div class="top-left">
        <label for="affiliate-select">Escolha um afiliado (ou digite seu apelido):</label>
        <select id="affiliate-select">
          <option value="">-- Carregando afiliados... --</option>
        </select>
        <div style="margin-top:8px;">
          <label for="manual-name">Ou digite seu apelido (limpo):</label>
          <input id="manual-name" type="text" placeholder="Ex: joao-silva (sem espaços ou símbolos)" />
          <div class="small">Dica: evite símbolos; o sistema normaliza para URL.</div>
        </div>
      </div>

      <div style="flex:0 0 320px;">
        <label>Pré-visualização da mensagem para WhatsApp:</label>
        <div class="link-preview" id="message-preview">—</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-outline" id="btn-generate">Gerar link</button>
          <button class="btn" id="btn-copy" title="Copiar link WhatsApp" disabled>Copiar link</button>
          <span id="copy-ok" class="copy-ok" style="display:none; color:#00ff8a; font-weight:700; margin-left:8px;">Copiado!</span>
        </div>
        <div style="margin-top:8px;font-size:12px;opacity:0.9">
          Link real é o URL pronto para WhatsApp.
        </div>
      </div>
    </div>

    <h2>Planos</h2>
    <div class="plans" id="plans-list"></div>

    <h2>Ranking de Afiliados</h2>
    <ul id="ranking-list">Carregando...</ul>

    <div style="margin-top: 20px; text-align: center;">
      <a class="wh-btn" id="fixed-whatsapp" href="#" target="_blank" style="text-decoration:none; font-size:16px;">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg" fill="#fff" style="vertical-align:middle;">
          <path d="M380.9 97.1C339 55.1 283.2 32 224 32 100.3 32 0 132.3 0 
          256c0 45 11.8 88.8 34.3 127.1L0 480l101.7-33.5C138.1 
          466.2 180.3 480 224 480h.1c123.7 0 224-100.3 
          224-224 0-59.2-23.1-115-67.1-158.9zM224 438.7c-39.3 
          0-77.8-11.3-110.9-32.7l-7.9-5-60.3 19.9 
          19.6-58.7-5.2-8.1c-20.8-32.5-31.8-70.1-31.8-108.8 
          0-110.1 89.9-200 200-200 53.4 0 103.6 20.8 
          141.4 58.6 37.8 37.8 58.6 88 58.6 141.4 
          0 110.1-89.9 200-200 200zm111.5-146.6c-6.1-3-36.1-17.8-41.7-19.8-5.6-2-9.7-3-13.8 
          3-4 6.1-15.9 19.8-19.5 23.8-3.6 4-7.1 4.5-13.2 
          1.5-36.1-18-59.8-32.2-83.8-72.7-6.3-10.9 
          6.3-10.1 18-33.6 2-4 1-7.5-.5-10.5-1.5-3-13.8-33.2-18.9-45.4-5-12.1-10.1-10.4-13.8-10.6-3.6-.2-7.6-.2-11.7-.2s-10.9 
          1.5-16.6 7.5c-5.7 6.1-21.8 21.4-21.8 52.3 0 30.9 22.4 60.8 25.5 
          64.9 3 4 43.9 67.1 106.5 94.1 14.9 6.4 26.5 
          10.2 35.6 13.1 15 4.8 28.6 4.1 39.4 2.5 
          12-1.8 36.1-14.8 41.2-29.1 5.1-14.3 5.1-26.5 
          3.6-29.1-1.5-2.6-5.6-4.1-11.7-7.1z"/>
        </svg>
        Falar no WhatsApp
      </a>
      <div style="font-size:13px;opacity:0.95; margin-top:4px;">Telefone: +55 77 9198-6049</div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    // CONFIGURAÇÕES
    const CSV_AFILIADOS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkBMVMdYu-Nfefrw8mqtyMtjNPJRteAnVWJw8aWBgVT6iq2EUMyjgNPGPlv5PUN7i38J_f4ui3bftm/pub?gid=0&single=true&output=csv';
    const CSV_RANKING_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkBMVMdYu-Nfefrw8mqtyMtjNPJRteAnVWJw8aWBgVT6iq2EUMyjgNPGPlv5PUN7i38J_f4ui3bftm/pub?gid=144607695&single=true&output=csv';
    const PHONE_NUMBER = "557791986049";

    const PLANS = [
      { id:'15dias', title: '15 DIAS DE USO', subtitle:'Teste - 15 dias', price: 'R$14,99' },
      { id:'mensal1', title: 'Mensal', subtitle:'1 acesso', price: 'R$20,99' },
      { id:'mensal2', title: 'Mensal', subtitle:'2 acessos', price: 'R$25,99' },
      { id:'bimestral1', title: 'Bimestral', subtitle:'1 acesso', price: 'R$41,99' },
      { id:'bimestral2', title: 'Bimestral', subtitle:'2 acessos', price: 'R$43,99' },
      { id:'trimestral1', title: 'Trimestral', subtitle:'1 acesso', price: 'R$74,99' },
      { id:'trimestral2', title: 'Trimestral', subtitle:'2 acessos', price: 'R$76,99' },
      { id:'semestral1', title: 'Semestral', subtitle:'1 acesso', price: 'R$149,99' },
      { id:'semestral2', title: 'Semestral', subtitle:'2 acessos', price: 'R$153,99' },
      { id:'anual1', title: 'Anual', subtitle:'1 acesso', price: 'R$297,99' },
      { id:'anual2', title: 'Anual', subtitle:'2 acessos', price: 'R$299,99' }
    ];

    // UTILITÁRIOS
    function makeSlug(name){
      return name.trim()
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9\-]+/g,'-')
        .replace(/\-+/g,'-')
        .replace(/^\-+|\-+$/g,'');
    }

    // DOM
    const affiliateSelect = document.getElementById('affiliate-select');
    const manualName = document.getElementById('manual-name');
    const messagePreview = document.getElementById('message-preview');
    const btnGenerate = document.getElementById('btn-generate');
    const btnCopy = document.getElementById('btn-copy');
    const copyOk = document.getElementById('copy-ok');
    const plansList = document.getElementById('plans-list');
    const rankingList = document.getElementById('ranking-list');
    const fixedWhatsapp = document.getElementById('fixed-whatsapp');

    let affiliates = [];

    // CARREGA afiliados do CSV para o select
    function loadAffiliates(){
      Papa.parse(CSV_AFILIADOS_URL, {
        download:true,
        header:true,
        complete: function(results){
          if(results.errors.length){
            console.error("Erro ao carregar afiliados CSV:", results.errors);
            affiliateSelect.innerHTML = `<option value="">Erro ao carregar afiliados</option>`;
            return;
          }
          affiliates = results.data.filter(a => a.apelido && a.apelido.trim() !== "");
          if(affiliates.length===0){
            affiliateSelect.innerHTML = `<option value="">Nenhum afiliado encontrado</option>`;
            return;
          }
          affiliateSelect.innerHTML = `<option value="">-- Selecione um afiliado --</option>`+
            affiliates.map(a => `<option value="${makeSlug(a.apelido)}">${a.apelido}</option>`).join('');
        }
      });
    }

    // Atualiza o preview da mensagem
    function updatePreview(){
      let chosen = affiliateSelect.value;
      let manual = manualName.value.trim();
      let slug = manual ? makeSlug(manual) : chosen;
      if(!slug){
        messagePreview.textContent = "Por favor, selecione ou digite um apelido.";
        btnCopy.disabled = true;
        return;
      }
      let msg = `Olá! Eu recomendo a ConectPlay. Use meu código de indicação: ${slug}. ` +
        `Teste grátis e planos acessíveis! Acesse pelo link:\n` +
        `https://www.conectplay.org/afiliado/${slug}`;
      messagePreview.textContent = msg;
      btnCopy.disabled = false;
    }

    // Copiar texto para área de transferência
    btnCopy.addEventListener('click', () => {
      const text = messagePreview.textContent;
      navigator.clipboard.writeText(text).then(() => {
        copyOk.style.display = "inline";
        setTimeout(() => copyOk.style.display = "none", 1500);
      });
    });

    // Gerar link do WhatsApp para venda com código do afiliado
    btnGenerate.addEventListener('click', () => {
      let chosen = affiliateSelect.value;
      let manual = manualName.value.trim();
      let slug = manual ? makeSlug(manual) : chosen;
      if(!slug){
        alert("Por favor, selecione ou digite um apelido válido.");
        return;
      }
      let url = `https://api.whatsapp.com/send?phone=${PHONE_NUMBER}&text=`+
        encodeURIComponent(`Olá! Quero assinar IPTV com o código de afiliado: ${slug}.`);
      window.open(url, '_blank');
    });

    // Exibe os planos na página
    function showPlans(){
      plansList.innerHTML = PLANS.map(p => `
        <div class="plan-card">
          <div class="plan-info">
            <div class="plan-title">${p.title}</div>
            <div class="plan-price">${p.subtitle} - <strong>${p.price}</strong></div>
          </div>
        </div>
      `).join('');
    }

    // Carrega o ranking do CSV público e exibe na lista
    function loadRanking(){
      Papa.parse(CSV_RANKING_URL, {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:function(results){
          if(results.errors.length){
            console.error("Erro ao carregar ranking CSV:", results.errors);
            rankingList.innerHTML = "<li>Erro ao carregar ranking.</li>";
            return;
          }
          let dados = results.data;
          // Ordena do maior para o menor número de vendas (coluna "Contagem")
          dados = dados.filter(d => d.Afiliado && d.Contagem)
                       .sort((a,b) => parseInt(b.Contagem) - parseInt(a.Contagem));

          rankingList.innerHTML = dados.map((item, i) =>
            `<li>${i+1}º - ${item.Afiliado}: ${item.Contagem} venda(s)</li>`
          ).join('');
        }
      });
    }

    // Eventos para atualizar preview ao mudar afiliado ou texto manual
    affiliateSelect.addEventListener('change', () => {
      manualName.value = "";
      updatePreview();
    });
    manualName.addEventListener('input', () => {
      affiliateSelect.value = "";
      updatePreview();
    });

    // Link fixo WhatsApp
    fixedWhatsapp.href = `https://api.whatsapp.com/send?phone=${PHONE_NUMBER}`;

    // Inicializa tudo
    loadAffiliates();
    showPlans();
    loadRanking();
    updatePreview();

  </script>
</body>
</html>
